# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Arena is a real-time chat/messenger application. Monorepo with three apps:
- **arena-app/** — React Native mobile/web client (Expo 54, React 19, TypeScript)
- **apps/backend/** — Spring Boot 3.5 REST + WebSocket server (Java 21) — **active development**
- **arena-backend/** — NestJS 11 REST + WebSocket server (TypeScript) — legacy, being replaced

## Common Commands

### Backend — Spring Boot (apps/backend/)
```bash
./gradlew build            # Compile + test
./gradlew bootRun          # Dev server (port 8003)
./gradlew test             # Run tests
./gradlew clean build      # Clean build
```

### Backend — NestJS Legacy (arena-backend/)
```bash
npm run start:dev          # Dev server with watch (port 8002)
npm run build              # Compile to dist/
npm run lint               # ESLint with auto-fix
npm run typecheck          # tsc --noEmit
npm run test               # Jest unit tests
npm run test:e2e           # E2E tests
npm run migration:run      # Apply TypeORM migrations
npm run migration:generate --name=MigrationName  # Generate migration from entity changes
npm run seed               # Seed database
npm run format             # Prettier
```

### Frontend (arena-app/)
```bash
npm start                  # Expo dev server
npm run ios                # Run on iOS
npm run android            # Run on Android
npm run web                # Run on web
npm run lint               # ESLint
npm run typecheck          # tsc --noEmit
npm run orval              # Regenerate API client from backend swagger
```

### Infrastructure (arena-backend/)
```bash
docker compose up -d       # Start PostgreSQL 18, Redis, LocalStack (S3), Adminer
```

## Architecture

### Backend (Spring Boot — apps/backend/)
- **Package**: `com.arena.backend` with domain-based packages under `domain/`
- **Domain pattern**: `*Controller.java`, `*Service.java`, `*Repository.java`, `*Entity.java`, `dtos/` per domain
- **Entities**: `domain/*/` — JPA entities (PostgreSQL), extend `BaseTimeEntity`
- **Global response DTOs** in `global/dto/`: `SingleApiResult<T>`, `ListApiResult<T>`, `InfinityListApiResult<T>`, `ApiResult`
- **Auth**: Supabase JWT (ES256) via Spring Security OAuth2 Resource Server + JWKS. `@CurrentUser JwtPayload` annotation
- **File storage**: S3 via AWS SDK v2 (LocalStack in dev)
- **ID generation**: `IdGenerator.generate()` — SecureRandom 12-char alphanumeric
- **Swagger**: springdoc-openapi at `/swagger` (UI), `/swagger-json` (spec)
- **JPA naming**: `globally_quoted_identifiers=true` + `PhysicalNamingStrategyStandardImpl` to match existing camelCase columns
- **Server port**: 8003

### Backend (NestJS Legacy — arena-backend/)
- **NestJS modular structure**: each domain in `src/modules/` (user, channel, message, contact, device, file, session, gateway)
- **Module pattern**: `*.module.ts`, `*.controller.ts`, `*.service.ts`, `dtos/` per module
- **Entities**: `src/entities/` — TypeORM entities (PostgreSQL)
- **Global response DTOs** in `src/dtos/`: `SingleApiResultDto<T>`, `ListApiResultDto<T>`, `InfinityListApiResultDto<T>`, `ApiResultDto`
- **Auth**: Supabase JWT validated via JWKS (`jwt-strategy.ts`). JWT `sub` = user ID
- **WebSocket**: Socket.IO gateway (`src/modules/gateway/arena.gateway.ts`) with signal pub/sub system (`src/signal/`)
- **File storage**: S3 via AWS SDK (LocalStack in dev)
- **ID generation**: nanoid (`src/utils/id-generator.ts`)
- **Swagger**: served at `/swagger`, JSON at `/swagger-json`
- **Controller routing**: base path on class `@Controller("/api/v1/resource")`, details on methods
- **Server port**: 8002

### Frontend
- **Expo Router** file-based routing in `app/` — routing only, no logic
- **Screen implementations** in `screens/` — where actual UI logic lives
  - Level 1 files: externally importable
  - `controls/` subfolder: internal to that screen only
- **`components/`**: only for truly cross-screen shared UI
- **Offline-first**: SQLite via expo-sqlite with structured layers:
  - `offline/db/schema/` — table name, column constants, row types, parse helpers
  - `offline/db/queries/` — CRUD functions importing from schema
  - `offline/db/migrations/` — immutable, sequential (`XXX_description.ts`)
- **API client**: auto-generated by Orval from backend Swagger spec (`api/generated/`)
- **Auth**: Supabase (Google + Kakao social login), token injected via Axios interceptor (`api/api-client.ts`)
- **State**: `useState` first, Zustand for cross-screen sharing. React Query not used (doesn't fit messenger caching model)
- **Path alias**: `@/` maps to project root (tsconfig)

## Coding Conventions

These rules apply across the project — do NOT violate them:

1. **No premature abstraction**: keep logic inline. Do not extract common functions unless explicitly requested. Explicit code over clever abstractions.
2. **One component per file**: `export default function ComponentName()`. No index.ts re-exports.
3. **Frontend DB queries**: params as first arg (object), optional `db` as second arg (for transactions). `upsertMany` self-wraps in transaction only when no external `db` is passed.
4. **Server DTOs on frontend**: use Orval-generated types from `api/generated/models/`. Only create separate UI models when joins require it.
5. **Backend DTO placement**: Spring Boot: `global/dto/` (response), `domain/*/dtos/` (request). NestJS: `src/dtos/` (response), `src/modules/*/dtos/` (request).

## Environment Setup

Backend requires `.env` file (see `.env.template`). Key vars: `DB_*` for PostgreSQL, `S3_*` / `AWS_*` for LocalStack, `REDIS_PORT`, `SUPABASE_JWKS_URI`, `SEED_USER_*` for seeding.

Frontend API endpoint is hardcoded to `http://localhost:8002` in `api/api-client.ts`.
